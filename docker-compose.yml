---

x-wal-g: &wal-g
  image: ${WAL_G_IMAGE:-apecloud/wal-g:postgres-1.2}
  environment:
    # 💿 Postgres
    PGHOST: ${POSTGRES_HOST:-127.0.0.1}
    PGPORT: ${POSTGRES_PORT:-5432}
    PGUSER: ${POSTGRES_USER:-postgres}
    PGPASSWORD: ${POSTGRES_PASSWORD:-password}
    PGDATABASE: ${POSTGRES_DB:-postgres}
    WALG_FILE_PREFIX: ${WALG_FILE_PREFIX}
    BACKUP_TYPE: ${BACKUP_TYPE:-full}
    # 💾 S3-хранилище
    WALG_S3_PREFIX: ${S3_PREFIX}
    AWS_ACCESS_KEY_ID: ${S3_USER}
    AWS_SECRET_ACCESS_KEY: ${S3_PASS}
    AWS_ENDPOINT: ${S3_HOST}
    AWS_REGION: ${AWS_REGION}
    # 💾 Backups
    BACKUP_NAME: ${BACKUP_NAME:-auto_backup_$(date +%Y-%m-%d_%H-%M-%S)}
    # RESTORE_BACKUP_NAME: ${RESTORE_BACKUP_NAME:-LATEST}
  volumes:
    - ./backups:/var/lib/wal-g/backups:z
    - ./restore:/var/lib/wal-g/restore:z

services:
  wal-g-backup:
    <<: *wal-g
    container_name: wal-g-backup
    command: >
      bash -c "
        if [ \"$${BACKUP_TYPE}\" = 'incr' ]; then
          echo '🟡 $${INCR_BACKUP_TEXT:-Incremental backup is in progress}...';
          wal-g backup-push /var/lib/postgresql/data;
        else
          echo '🟢 $${FULL_BACKUP_TEXT:-Full backup is in progress}...';
          wal-g backup-push /var/lib/wal-g;
        fi
      "

  wal-g-restore:
    <<: *wal-g
    container_name: wal-g-restore
    volumes:
      - ./backups:/var/lib/wal-g/backups
    command: >
      bash -c "
        echo '🧩 $${RESTORE_PROGRESS:-Restoring from backup} $${RESTORE_BACKUP_NAME}...';
        wal-g backup-fetch /var/lib/wal-g/restore $${RESTORE_BACKUP_NAME};
        echo '✅ $${RESTORE_COMPLETE:-Recovery completed. Data saved to} /var/lib/wal-g/restore';
      "

  wal-g-test:
    <<: *wal-g
    container_name: wal-g-test
    # Заглушка: контейнер запустится и будет висеть в фоне
    command: "sleep infinity"  # Или sleep infinity (если tail недоступен)
    # Если нужно переопределить ENTRYPOINT (из-за бага в образе):
    # entrypoint: ["/bin/bash"]