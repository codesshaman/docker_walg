---

x-wal-g: &wal-g
  image: ${WAL_G_IMAGE:-stratospire/wal-g:1.0}
  environment:
    # üíø Postgres
    PGHOST: ${POSTGRES_HOST:-127.0.0.1}
    PGPORT: ${POSTGRES_PORT:-5432}
    PGUSER: ${POSTGRES_USER:-postgres}
    PGPASSWORD: ${POSTGRES_PASS:-postgres}
    PGDATABASE: ${POSTGRES_DB:-postgres}
    WALG_FILE_PREFIX: ${WALG_FILE_PREFIX}
    BACKUP_TYPE: ${BACKUP_TYPE:-full}
    # üíæ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    WALG_S3_PREFIX: ${S3_PREFIX}
    AWS_ACCESS_KEY_ID: ${S3_USER}
    AWS_SECRET_ACCESS_KEY: ${S3_PASS}
    AWS_ENDPOINT: ${S3_HOST}
    AWS_REGION: ${AWS_REGION}
    AWS_S3_FORCE_PATH_STYLE: "true"
    # üíæ Backups
    BACKUP_NAME: ${BACKUP_NAME:-auto_backup_$(date +%Y-%m-%d_%H-%M-%S)}
    BACKUP_TIME: "" # –ù–µ —Ç—Ä–æ–≥–∞—Ç—å. –ú–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    # RESTORE_BACKUP_NAME: ${RESTORE_BACKUP_NAME:-LATEST}
  volumes:
    - ./backups:/var/lib/wal-g/backups:z
    - $DB_VOLUME:/var/lib/wal-g/restore
    - $DB_VOLUME:/var/lib/postgresql/data

services:
  wal-g-backup:
    <<: *wal-g
    container_name: wal-g-backup
    command: >
      bash -c "
        if [ \"$${BACKUP_TYPE}\" = 'incr' ]; then
          echo 'üü° $${INCR_BACKUP_TEXT:-Incremental backup is in progress}...';
          wal-g backup-push /var/lib/postgresql/data;
        else
          echo 'üü¢ $${FULL_BACKUP_TEXT:-Full backup is in progress}...';
          wal-g backup-push /var/lib/postgresql/data --full;
        fi
      "
    networks:
      network:
        ipv4_address: $BACKUP_HOST

  wal-g-restore:
    <<: *wal-g
    container_name: wal-g-restore
    command: >
      "echo 'Restore is running!'"
    networks:
      network:
        ipv4_address: $RESTORE_HOST

  wal-g-list:
    <<: *wal-g
    container_name: wal-g-list
    entrypoint: /bin/sh
    # command: -c 'wal-g backup-list | tail -n +2 | awk '\''{gsub(/T/, " ",$2); gsub(/\.[0-9]+Z/, "", $2); gsub(/Z/, "", $2); print $2}'\'''
    command: -c "wal-g backup-list | tail -n +2 | awk '{print \$1, \$2}'"
    networks:
      network:
        ipv4_address: $LIST_HOST

  wal-g-conf:
    <<: *wal-g
    container_name: wal-g-conf
    entrypoint: /bin/sh
    command: >
      -c '
      sed -i "s|^#restore_command *=.*|restore_command = '\''wal-g wal-fetch \"%f\" \"%p\"'\''|" "/var/lib/postgresql/data/postgresql.conf";
      sed -i "s|^#recovery_target_timeline *=.*|recovery_target_timeline = '\''latest'\''|" "/var/lib/postgresql/data/postgresql.conf";
      sed -i "s|^#recovery_target_time *=.*|recovery_target_time = '\''$BACKUP_TIME'\''|" "/var/lib/postgresql/data/postgresql.conf";
      '
    networks:
      network:
        ipv4_address: $CONF_HOST

  wal-g-test:
    <<: *wal-g
    container_name: wal-g-test
    restart: unless-stopped
    entrypoint: ["/bin/sh", "-c"]
    command: ["while true; do sleep 3600; done"]
    networks:
      network:
        ipv4_address: $TEST_HOST

networks:
  network:
    name: $POSTGRES_NET
    external: true
    driver: bridge
