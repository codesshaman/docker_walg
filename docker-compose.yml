---

x-wal-g: &wal-g
  image: ${WAL_G_IMAGE:-apecloud/wal-g:postgres-1.2}
  environment:
    PGHOST: ${POSTGRES_HOST:-127.0.0.1}
    PGPORT: ${POSTGRES_PORT:-5432}
    PGUSER: ${POSTGRES_USER:-postgres}
    PGPASSWORD: ${POSTGRES_PASSWORD:-password}
    PGDATABASE: ${POSTGRES_DB:-postgres}
    WALG_FILE_PREFIX: ${WALG_FILE_PREFIX:-/var/lib/wal-g/backups}
    BACKUP_TYPE: ${BACKUP_TYPE:-full}
    BACKUP_NAME: ${BACKUP_NAME:-auto_backup_$(date +%Y-%m-%d_%H-%M-%S)}
    RESTORE_BACKUP_NAME: ${RESTORE_BACKUP_NAME:-LATEST}
    USER_ID: ${USER_ID}
  volumes:
    - ./backups:/var/lib/wal-g/backups:z
    - ./restore:/var/lib/wal-g/restore:z

services:
  wal-g-backup:
    <<: *wal-g
    container_name: wal-g-backup
    command: >
      bash -c "
        if [ \"$${BACKUP_TYPE}\" = 'incr' ]; then
          echo 'ðŸŸ¡ $${INCR_BACKUP_TEXT:-Incremental backup is in progress}...';
          wal-g backup-push;
        else
          echo 'ðŸŸ¢ $${FULL_BACKUP_TEXT:-Full backup is in progress}...';
          wal-g backup-push /var/lib/wal-g;
        fi
      "

  wal-g-restore:
    <<: *wal-g
    container_name: wal-g-restore
    volumes:
      - ./backups:/var/lib/wal-g/backups
    command: >
      bash -c "
        echo 'ðŸ§© $${RESTORE_PROGRESS:-Restoring from backup} $${RESTORE_BACKUP_NAME}...';
        wal-g backup-fetch /var/lib/wal-g/restore $${RESTORE_BACKUP_NAME};
        echo 'âœ… $${RESTORE_COMPLETE:-Recovery completed. Data saved to} /var/lib/wal-g/restore';
      "

  wal-g-test:
    <<: *wal-g
    container_name: wal-g-test
    # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ°: ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð¸ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð¸ÑÐµÑ‚ÑŒ Ð² Ñ„Ð¾Ð½Ðµ
    command: "sleep infinity"  # Ð˜Ð»Ð¸ sleep infinity (ÐµÑÐ»Ð¸ tail Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)
    # Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ENTRYPOINT (Ð¸Ð·-Ð·Ð° Ð±Ð°Ð³Ð° Ð² Ð¾Ð±Ñ€Ð°Ð·Ðµ):
    # entrypoint: ["/bin/bash"]